{% extends "base.html" %}

{% block title %} PRECOGx | precog3D Structural Analysis {% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="https://www.ebi.ac.uk/pdbe/pdb-component-library/css/pdbe-molstar-1.2.1.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
{% endblock %}

{% block content %}
<section class="py-4" id="precog3D">
    <div class="container">
        <div class="row justify-content-center text-center mb-5">
            <div class="col-lg-9">
                <h1 class="fw-light font-base fs-5 fs-xxl-6"><strong>precog3D</strong></h1>
                <p class="lead text-muted">Structural visualization of GPCR-G Protein complexes and predicted coupling values.</p>

            </div>
        </div>

        <div class="row justify-content-center mb-5">
            <div class="col-md-10 col-lg-8">
                <div class="input-group shadow-sm">
                    <input type="text" id="gene" class="form-control form-control-lg" placeholder="Type receptor/Family (e.g. 5HT, Vasopressin, Adrenoceptors)...">
                    <button class="btn btn-primary px-4" type="button" data-bs-toggle="modal" data-bs-target="#browseModal">
                        <i class="fas fa-list-ul me-2"></i> Browse All
                    </button>
                    <input type="hidden" id="selected_receptor_id">
                </div>
            </div>
        </div>

        <div id="results-section" style="display: none;">
            <div class="row justify-content-center mb-4">
                <div class="col-12 col-lg-10">
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="bg-white py-2">
                            <h5 class="mb-0 fw-bold header-card">Coupling values</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                            <table id="couplingTable" class="table table-hover table-bordered w-100">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                                 <p class="text-muted">
                                Click on any G-protein cell in the table to load and visualize the corresponding 3D complex structure.
                            </p>
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center mb-4">
                <div class="col-12 col-lg-10">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
                           <div class="d-flex gap-3 small">
                            <span><i class="fas fa-circle" style="color: #f00;"></i> High B-factors (Red)</span>
                            <span><i class="fas fa-circle" style="color: #00f;"></i> Low B-factors (Blue)</span>
                        </div>
                        </div>
                        <div class="card-body p-0 border">
                            <div id="myViewer"></div>
                        </div>
                        <div class="card-footer bg-light small text-center text-muted">
                            Model colored by B factor.
                        </div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-center mb-4"></div>
        </div>
    </div>
</section>

<div class="modal fade" id="browseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold"><i class="fas fa-dna me-2"></i>Select Receptor by Family</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="accordion accordion-flush" id="accordionReceptors"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-plugin-3.1.2.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script>

       function getLevenshteinDistance(a, b) {
        if(a.length==0) return b.length; if(b.length==0) return a.length;
        var matrix=[]; var i; for(i=0;i<=b.length;i++){matrix[i]=[i];}
        var j; for(j=0;j<=a.length;j++){matrix[0][j]=j;}
        for(i=1;i<=b.length;i++){for(j=1;j<=a.length;j++){
            if(b.charAt(i-1)==a.charAt(j-1)){matrix[i][j]=matrix[i-1][j-1];}
            else{matrix[i][j]=Math.min(matrix[i-1][j-1]+1,Math.min(matrix[i][j-1]+1,matrix[i-1][j]+1));}
        }} return matrix[b.length][a.length];
    }

    const apiBaseUrl = '/api';
    let allReceptors = [];
    let dataTableInstance = null;

    let viewerInstance = new PDBeMolstarPlugin();

    let loadSubscription = null;

    $(document).ready(function() {
        // Initialize phylogenetic data
        fetch(`${apiBaseUrl}/receptors-complex`)
            .then(response => response.json())
            .then(data => {
                const accordion = $('#accordionReceptors');
                let index = 0;

                for (const [family, receptors] of Object.entries(data)) {
                    receptors.forEach(item => {
                        allReceptors.push({
                            id: item.id,
                            label: item.text,
                            protein: item.protein,
                            family: family,
                            desc: item.desc,
                            coupling: item.coupling,
                            searchStr: `${item.search_text} ${item.protein} ${family}`.toLowerCase()
                        });
                    });

                    const collapseId = `collapse${index}`;
                    let groupHtml = `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed fw-bold py-3" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                    ${family} <span class="badge rounded-pill bg-light text-primary border ms-2">${receptors.length}</span>
                                </button>
                            </h2>
                            <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#accordionReceptors">
                                <div class="accordion-body p-0">`;

                    receptors.forEach(r => {
                        groupHtml += `
                            <div class="receptor-list-item d-flex justify-content-between align-items-center" onclick="selectReceptor('${r.id}')">
                                <div>
                                    <div class="fw-bold text-dark">${r.text} <span class="badge bg-light text-muted fw-normal">${r.protein}</span></div>
                                    <small class="text-muted italic">${r.desc || ''}</small>
                                </div>
                                <i class="fas fa-chevron-right text-muted opacity-50"></i>
                            </div>`;
                    });
                    groupHtml += `</div></div></div>`;
                    accordion.append(groupHtml);
                    index++;
                }
            });

          $("#gene").autocomplete({
            minLength: 2,
            source: function(request, response) {
                var term = request.term.toLowerCase();
                var termWords = term.split(/\s+/);
                var filtered = allReceptors.filter(function(item) {
                    var searchStr = item.searchStr;
                    if (searchStr.indexOf(term) > -1) return true;
                    var matches = 0;
                    for (var t=0; t<termWords.length; t++) {
                        var tWord = termWords[t];
                        var wordFound = false;
                        var searchWords = searchStr.split(/\s+/);
                        for (var s=0; s<searchWords.length; s++) {
                            var sWord = searchWords[s];
                            if (tWord.length<3) { if(sWord.indexOf(tWord)>-1){wordFound=true;break;} continue;}
                            var dist = getLevenshteinDistance(tWord, sWord);
                            var tolerance = (sWord.length>7)?3:((sWord.length>4)?2:1);
                            if (dist<=tolerance) { wordFound=true; break; }
                        }
                        if (wordFound) matches++;
                    }
                    return matches === termWords.length;
                });
                response(filtered.slice(0, 25));
            },
            select: function(event, ui) {
               selectReceptor(ui.item.value);
                return false;
            }
        }).autocomplete( "instance" )._renderItem = function( ul, item ) {
             return $( "<li>" )
                .append(`<div>
                            <div class="d-flex justify-content-between">
                                <strong>${item.label} [<i>${item.protein}</i>]</strong>
                                <span class="badge bg-light text-secondary border">${item.family}</span>
                            </div>
                            <small class='text-muted'>${item.desc}</small>
                         </div>`)
                .appendTo( ul );
        };
    });


    function selectReceptor(id) {

    $.getJSON(`/api/precog3d/${id}`, function(apiData) {
        if (apiData && !apiData.error) {
            $("#gene").val(apiData.GPCR_name);

            updateCouplingTable(apiData);

            $("#results-section").fadeIn(400);

            const modalEl = document.getElementById('browseModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            loadStructure("");

            setTimeout(() => {
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open').css('overflow-y', 'auto');
            }, 300);
        }
    }).fail(function() {
        alert("Error: " + id);
    });
}
function formatTableValue(val) {
    const num = parseFloat(val);
    if (isNaN(num)) return val;
    const statusClass = num > 4.0 ? 'significant-value' : 'text-dark';
    return `<span class="${statusClass}">${num.toFixed(2)}</span>`;
}

function updateCouplingTable(rowData) {
    if (!rowData) return;

    if (!rowData) return;

    if (dataTableInstance) {
        dataTableInstance.destroy();
        $('#couplingTable').empty();
    }

    if ($('#couplingTable thead').length === 0) {
        $('#couplingTable').append('<thead></thead><tbody></tbody>');
    }

    const fmt = (val) => {
        const n = parseFloat(val);
        if (isNaN(n)) return val;
        const cls = n > 4.0 ? 'significant-value' : '';
        return `<span class="${cls}">${n.toFixed(3)}</span>`;
    };

    dataTableInstance = $('#couplingTable').DataTable({
        data: [rowData],
        dom: '<"d-flex justify-content-between align-items-center mb-3"Bf>rt<"d-flex justify-content-between mt-3"ip>',
        buttons: [
            { extend: 'copy', className: 'dt-button' },
            { extend: 'csv', className: 'dt-button' },
            { extend: 'excel', className: 'dt-button' }
        ],
        columns: [
            { data: 'GPCR_name', title: 'GPCR' },
            { data: 'GNA11', title: 'GNA11', render: fmt },
            { data: 'GNA12', title: 'GNA12', render: fmt },
            { data: 'GNA13', title: 'GNA13', render: fmt },
            { data: 'GNA14', title: 'GNA14', render: fmt },
            { data: 'GNA15', title: 'GNA15', render: fmt },
            { data: 'GNAI1', title: 'GNAI1', render: fmt },
            { data: 'GNAI2', title: 'GNAI2', render: fmt },
            { data: 'GNAI3', title: 'GNAI3', render: fmt },
            { data: 'GNAL', title: 'GNAL', render: fmt },
            { data: 'GNAO1', title: 'GNAO1', render: fmt },
            { data: 'GNAQ', title: 'GNAQ', render: fmt },
            { data: 'GNAS', title: 'GNAS', render: fmt },
            { data: 'GNAZ', title: 'GNAZ', render: fmt },
            { data: 'GPCR_class', title: 'Class' }
        ],
        paging: false,
        scrollX: true,
        searching: false,
        info: false
    });
}


function loadStructure(receptorId) {
        const viewerDiv = document.getElementById('myViewer');
        const url = `${apiBaseUrl}/structure/${receptorId}`;

        console.log("Getting:", url);

        const options = {
            customData: {
                url: url,
                format: 'mmcif',
            },
            alphafoldView: true,
            bgColor: {r: 255, g: 255, b: 255},
            hideStructureControls: true,
            hideCanvasControls: ['selection', 'animation', 'controlToggle', 'controlInfo']
        };

        const isFirstLoad = viewerDiv.querySelector('canvas') === null;

        if (isFirstLoad) {
            viewerInstance.render(viewerDiv, options);
        } else {
            viewerInstance.visual.update(options);
        }

        if (loadSubscription) {
            loadSubscription.unsubscribe();
        }

        loadSubscription = viewerInstance.events.loadComplete.subscribe(colorPolymerBySecStr);
    }

    function colorPolymerBySecStr() {
    const cells = Array.from(viewerInstance.plugin.state.data.cells.values());
    const polymerComponents = cells.filter(c => c.transform.tags?.includes('structure-component-static-polymer'));
    for (const component of polymerComponents) {
        const polymerRepresentations = viewerInstance.plugin.state.data.tree.children.get(component.transform.ref);
        for (const repr of polymerRepresentations) {
            viewerInstance.plugin.build().to(repr).update({ colorTheme: { name: 'uncertainty', params: {} } }).commit();
        }
    }
}


$(document).ready(function() {
    $('body').on('click', '.dataTables_scrollBody td', function () {

        if (!dataTableInstance) return;

        var cell = dataTableInstance.cell(this);

        if (cell.index() === undefined) return;

        var columnIndex = cell.index().column;
        var rowIndex = cell.index().row;

        var columnName = dataTableInstance.column(columnIndex).header().innerText.trim();

        var rowData = dataTableInstance.row(rowIndex).data();
        var gpcrName = rowData.GPCR_name;

        if (columnName === "GPCR" || columnName === "Class") {
            return;
        }

        $('td.selected-cell').removeClass('selected-cell');
        $(this).addClass('selected-cell');

        console.log("Carregando:", gpcrName, "_", columnName);

        loadStructure(gpcrName + "_" + columnName);
    });
});
</script>
{% endblock %}