{% extends "base.html" %}

{% block title %} PRECOGx | Result | {{uniq_id|safe}} {% endblock %}

{% block head %}
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.1.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.1.0/js/buttons.colVis.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.1.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.1.0/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

<script src="{{url_for('static', filename='/js/sequence-viewer.bundle.js')}}"></script>
<script src="{{url_for('static', filename='/js/plotly-plotly.js-da2cd8c/dist/plotly.min.js')}}"></script>
<script src="{{url_for('static', filename='/js/dataT.js')}}"></script>
<script src="{{url_for('static', filename='/js/ngl.js')}}"></script>
<script src="{{url_for('static', filename='/js/structure.js')}}"></script>
<script src="{{url_for('static', filename='/js/sequence.js')}}"></script>
<script src="{{url_for('static', filename='/js/heatmap.js')}}"></script>
<script src="{{url_for('static', filename='/js/attentionmap.js')}}"></script>
<script src="{{url_for('static', filename='/js/pca.js')}}"></script>

<link href="https://unpkg.com/intro.js/minified/introjs.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="{{url_for('static', filename='/css/reset.css')}}" rel="stylesheet"/>
<link href="{{url_for('static', filename='/css/theme_unified.css')}}" rel="stylesheet">

<script>
    function loadIntro() {
        introJs().start();
    }
</script>
{% endblock%}

{% block content %}
<section class="pt-xxl-4" id="result">
    <div class="container">

        <h1 class="fw-bold mb-4">Result
            <span class="btn btn-info btn-sm" onclick="loadIntro()">Need a quick intro?</span>
        </h1>

        <div class="row align-items-center mb-5">
            <div class="col-xl-12"
                 data-intro='This panel displays PRECOGx-predicted probabilites, and the information known about the input(s) in GtoPdb, TGF/GEMTA assays or STRING (for B-arrs).'
                 data-step="1">
                <div class="card">
                    <div class="card-body">
                        <h2 class="header-title">Coupling probabilites
                            <span class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#dataModal">?</span>
                        </h2>
                        <table id="example" class="table display table-striped table-bordered stripe row-border order-column pb-2" width="100%"></table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">

            <div class="col-xl-6  mb-5 d-flex"
                 data-intro='This panel displays the predicted differential conctacts for a given transducer group. Using the dropdown menu, one can select to view the contacts in 1D or 2D format.'
                 data-step="2">
                <div class="card w-100">
                    <div class="card-body">
                        <h2 class="header-title" id="panelHeading">Contacts
                            <span class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#contactsModal">?</span>
                        </h2>

                        <div class="row g-3 align-items-center pb-5">
                            <div class="col-auto">
                                <button type="button" id="displayName" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                    Select display
                                </button>
                                <ul id="displayList" class="dropdown-menu"></ul>
                            </div>

                            <div class="col-auto" id="slider_log">
                                <label for="slider1A" class="col-form-label fw-bold">Log odds score</label>
                                <button type="button" class="btn btn-info btn-circle slider-control" data-target="#slider1A" data-action="minus">-</button>
                                <input type="range" class="form-range sync-slider-a" style="width: 3rem; vertical-align: middle;"
                                       min="0.0" max="1.0" step="0.1" value="0.2" id="slider1A">
                                <button type="button" class="btn btn-info btn-circle slider-control" data-target="#slider1A" data-action="plus">+</button>
                                <span id="slider1A_value">0.2</span>
                            </div>

                            <div class="col-auto" id="slider_dis">
                                <label for="slider1B" class="col-form-label">Distance</label>
                                <button type="button" class="btn btn-info btn-circle slider-control" data-target="#slider1B" data-action="minus">-</button>
                                <input type="range" class="form-range sync-slider-b" style="width: 3rem; vertical-align: middle;"
                                       min="0" max="20" step="1" value="0" id="slider1B">
                                <button type="button" class="btn btn-info btn-circle slider-control" data-target="#slider1B" data-action="plus">+</button>
                                <span id="slider1B_value">0</span>
                            </div>
                        </div>

                        <div id="sequence-viewer"></div>
                        <div id='myDiv' class="aspect-square"></div>
                    </div>
                </div>
            </div>

            <div class="col-xl-6  mb-5 d-flex"
                 data-intro='This panel displays the predicted differential contacts for a transducer group mapped on a 3D structure of the input.'
                 data-step="3">
                <div class="card w-100">
                    <div class="card-body">
                        <h2 class="header-title">Structure
                            <span class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#structureModal">?</span>
                        </h2>

                        <div class="row g-3 align-items-center">
                             <div class="col-auto">
                                <button type="button" id="PDBbutton" class="btn btn-primary btn-sm dropdown-toggle fs--1" data-bs-toggle="dropdown">
                                    PDB-ID
                                </button>
                                <ul id="pdblist" class="dropdown-menu"></ul>
                             </div>
                             <div class="col-auto">
                                <label for="PDBsource">PDB</label>
                                <input class="form-check-input" type="radio" id="PDBsource" name="3Dsource" value="PDB" checked>
                                <label for="AFsource">AlphaFold</label>
                                <input class="form-check-input" type="radio" id="AFsource" name="3Dsource" value="AF">
                             </div>
                        </div>

                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="slider2A" class="col-form-label fw-bold">Log odds score</label>
                                <button type="button" class="btn btn-info btn-circle slider-control" data-target="#slider2A" data-action="minus">-</button>
                                <input type="range" class="form-range sync-slider-a" style="width: 8rem; vertical-align: middle;"
                                       min="0.0" max="1.0" step="0.1" value="0.2" id="slider2A">
                                <button type="button" class="btn btn-info btn-circle slider-control" data-target="#slider2A" data-action="plus">+</button>
                                <span id="slider2A_value">0.0</span>
                            </div>
                            <div class="col-auto">
                                <label for="slider2B" class="col-form-label">Distance</label>
                                <button type="button" class="btn btn-info btn-circle slider-control" data-target="#slider2B" data-action="minus">-</button>
                                <input type="range" class="form-range sync-slider-b" style="width: 8rem; vertical-align: middle;"
                                       min="0" max="20" step="1" value="0" id="slider2B">
                                <button type="button" class="btn btn-info btn-circle slider-control" data-target="#slider2B" data-action="plus">+</button>
                                <span id="slider2B_value">0</span>
                            </div>
                        </div>

                        <div id="viewport" class="align-items-center fs--2 w-100"></div>
                    </div>
                </div>
            </div>
        </div> <div class="row">

            <div class="col-xl-6 mb-5 d-flex" data-intro='This panel displays embeddings of all GPCRs mapped onto 2D space using PCA.' data-step="4">
                <div class="card w-100">
                    <div class="card-body">
                        <h2 class="header-title">PCA
                            <span class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#pcaModal">?</span>
                        </h2>
                        <div class="p-1 fs--3">
                            <div class="dropdown" id="labels">
                                <button type="button" id="AssayButton" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">Assay</button>
                                <ul id="AssayList" class="dropdown-menu"></ul>
                                <button type="button" id="PCAButton" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">PCA</button>
                                <ul id="PCAList" class="dropdown-menu"></ul>
                            </div>
                            <div class="form-check form-switch mt-2">
                              <input class="form-check-input" type="checkbox" id="flexSwitchVariants">
                              <label class="form-check-label" for="flexSwitchVariants">Show all inputs</label>
                            </div>
                            <div id='myDiv2'></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-6 mb-5 d-flex" data-intro='This panel displays the attention map.' data-step="5">
                <div class="card w-100">
                    <div class="card-body">
                        <h2 class="header-title">Attention Map
                            <span class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#attentionMapModal"
                                  data-intro='Click on help buttons to know more about each panel.' data-step="6">?</span>
                        </h2>
                        <div id='attentionMap'  class="aspect-square" style="text-align: center;"></div>

                        <div style="display:none;">
                            <span id="slider1B_value_hidden"></span>
                            <span id="slider1A_value_hidden"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div> <div id="modalCoupling"></div>
</section>

<script>
$(document).ready(function() {

    // --- Initialization ---
    $("#modalCoupling").load("/static/html/modals.html");

    // NGL Stage Init
    window.stage = new NGL.Stage("viewport");
    window.stage.setParameters({ backgroundColor: "white" });

    var UNIQ_ID = {{ uniq_id|safe }};
    var PATH_FASTA = {{ path_to_fasta|safe }};
    var PATH_JSON = {{ path_to_json_output|safe }};

    // Initial Data Load
    makeDatatable(
        PATH_JSON,
        PATH_FASTA,
        UNIQ_ID,
        {{ gpcr_list|safe }},
        {{ first_gprotein|safe }},
        {{ first_gprotein_index|safe }}
    );

    // Initial Visualization Render
    var initial_gpcr = {{ first_entry|safe }};
    var initial_gprotein = {{ first_gprotein|safe }};

    updateVisualizations(0.0, 0.0, initial_gpcr, initial_gprotein, 'Sequence');

    // Sync initial slider text values
    $('#slider1A_value').text($('#slider1A').val());
    $('#slider1B_value').text($('#slider1B').val());
    $('#slider2A_value').text($('#slider2A').val());
    $('#slider2B_value').text($('#slider2B').val());

    // --- Event Listeners ---

    $('#displayList').on('click', 'a, li', function(e) {
        e.preventDefault();
        var txt = $(this).text();
        $('#displayName').text(txt);
        handleSliderChange();
    });

    // 1. Radio Button: PDB vs AlphaFold
    $('input[type=radio][name=3Dsource]').change(function() {
        let vals = getCurrentValues();
        makeStructure(vals.gpcr, vals.gprotein, vals.scoreA, vals.distB, UNIQ_ID);
    });

    // PCA Toggle: Show all inputs (Mutations)
    $('#flexSwitchVariants').change(function() {
        handleSliderChange(); // This will trigger updateVisualizations which reads the checkbox
    });

    // 2. Unified Slider Logic (Button Clicks)
    $(".slider-control").click(function(e) {
        e.preventDefault();
        let targetId = $(this).data("target");
        let action = $(this).data("action");
        let $slider = $(targetId);

        let step = parseFloat($slider.attr("step"));
        let currentVal = parseFloat($slider.val());
        let newVal = (action === "plus") ? currentVal + step : currentVal - step;

        // Respect min/max
        let min = parseFloat($slider.attr("min"));
        let max = parseFloat($slider.attr("max"));
        if (newVal < min) newVal = min;
        if (newVal > max) newVal = max;

        // Round to 1 decimal place
        if (step < 1) newVal = parseFloat(newVal.toFixed(1));

        $slider.val(newVal).trigger('input');
    });

    // 3. Unified Slider Logic (Input Change & Synchronization)
    $(document).on('input', '.sync-slider-a', function() {
        let val = $(this).val();
        $('#slider1A, #slider2A').val(val);
        $('#slider1A_value, #slider2A_value').text(val);
        handleSliderChange();
    });

    $(document).on('input', '.sync-slider-b', function() {
        let val = $(this).val();
        $('#slider1B, #slider2B').val(val);
        $('#slider1B_value, #slider2B_value').text(val);
        handleSliderChange();
    });

    // --- Helper Functions ---

    function getCurrentValues() {
        // Fallback to initial values if data attribute is empty
        var selected_gpcr = $('#selected').data('gpcr');
        var selected_gprotein = $('#selected').data('gprotein');

        return {
            gpcr: selected_gpcr ? selected_gpcr : initial_gpcr,
            gprotein: selected_gprotein ? selected_gprotein : initial_gprotein,
            scoreA: $('#slider1A').val(),
            distB: $('#slider1B').val(),
            displayName: $('#displayName').text().trim() === 'Select display' ? 'Sequence' : $('#displayName').text().trim()
        };
    }

    function handleSliderChange() {
        let vals = getCurrentValues();
        updateVisualizations(vals.scoreA, vals.distB, vals.gpcr, vals.gprotein, vals.displayName);
    }

    window.updateVisualizations = updateVisualizations;

    function updateVisualizations(sliderAVal, sliderBVal, gpcr, gprotein, displayName) {

        var pcaOption = $('#flexSwitchVariants').is(':checked') ? '2' : '1';

        makeStructure(gpcr, gprotein, sliderAVal, sliderBVal, UNIQ_ID);
        makeHeatmap(sliderAVal, sliderBVal, gpcr, gprotein, displayName);
        makeAttentionmap(UNIQ_ID, gpcr, gprotein, displayName);
        setDisplayMenu(PATH_FASTA, sliderAVal, sliderBVal, UNIQ_ID, gpcr, gprotein, displayName);
        makeSequence(gpcr, PATH_FASTA, gprotein, sliderAVal, sliderBVal, UNIQ_ID, displayName);
        makePCA(UNIQ_ID, 'TGF', '33', pcaOption, gpcr, gprotein);
    }

    window.click3Dsource = function(element) {
       let vals = getCurrentValues();
       makeStructure(vals.gpcr, vals.gprotein, vals.scoreA, vals.distB, UNIQ_ID);
    };
});
</script>
{% endblock%}